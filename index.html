<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Medical Receipt Scanner - Async Processing</title>
    <style>
      :root { color-scheme: light dark; }
      body { 
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; 
        margin: 24px; 
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
      }
      h1 { font-size: 1.6rem; margin: 0 0 8px; }
      .card { 
        border: 1px solid #8883; 
        border-radius: 8px; 
        padding: 20px; 
        margin: 16px 0; 
        background: #fff;
      }
      label { display: block; font-weight: 600; margin: 12px 0 6px; }
      input[type="text"] { 
        width: 100%; 
        padding: 10px; 
        border: 1px solid #ccc; 
        border-radius: 6px; 
        font-size: 14px;
      }
      input[type="file"] {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 6px;
        width: 100%;
      }
      .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
      button { 
        padding: 10px 16px; 
        border-radius: 6px; 
        border: 1px solid #8886; 
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      button.primary { 
        background: #2f6fed; 
        color: white; 
        border-color: #2f6fed; 
      }
      button.primary:hover:not(:disabled) {
        background: #1e5dd8;
      }
      .muted { color: #777; font-size: 0.9rem; }
      .thumbs { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
        gap: 10px; 
        margin-top: 12px;
      }
      .thumb { 
        border: 1px solid #ccc; 
        border-radius: 6px; 
        padding: 8px; 
        text-align: center;
      }
      .thumb img { 
        max-width: 100%; 
        height: auto; 
        display: block; 
        border-radius: 4px;
      }
      pre { 
        background: #1112; 
        padding: 12px; 
        border-radius: 6px; 
        overflow: auto; 
        max-height: 400px;
        font-size: 13px;
      }
      .ok { color: #1a7f37; font-weight: 600; }
      .err { color: #d12; font-weight: 600; }
      .warning { color: #f90; font-weight: 600; }
      
      /* Progress Bar */
      .progress-container {
        margin: 16px 0;
        display: none;
      }
      .progress-container.active {
        display: block;
      }
      .progress-bar {
        width: 100%;
        height: 30px;
        background: #f0f0f0;
        border-radius: 15px;
        overflow: hidden;
        position: relative;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #2f6fed, #1e5dd8);
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 13px;
      }
      .progress-text {
        text-align: center;
        margin-top: 8px;
        font-size: 14px;
        color: #555;
      }
      
      /* Spinner */
      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #2f6fed;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 8px;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Result Table */
      .result-table { 
        width: 100%; 
        border-collapse: collapse; 
        margin-top: 12px; 
        overflow-x: auto; 
        font-size: 14px;
      }
      .result-table th { 
        background: #f5f5f5; 
        padding: 12px; 
        text-align: left; 
        border: 1px solid #ddd; 
        font-weight: 600; 
        white-space: nowrap;
      }
      .result-table td { 
        padding: 10px 12px; 
        border: 1px solid #ddd; 
        vertical-align: top; 
      }
      .result-table tr:nth-child(even) { background: #f9f9f9; }
      .result-table tr:hover { background: #f0f0f0; }
      .amount { text-align: right; font-weight: 600; }
      .empty-result { 
        text-align: center; 
        padding: 40px 20px; 
        color: #999; 
      }
      
      /* Status Badge */
      .status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
      }
      .status-processing {
        background: #fff3cd;
        color: #856404;
      }
      .status-completed {
        background: #d4edda;
        color: #155724;
      }
      .status-error {
        background: #f8d7da;
        color: #721c24;
      }
      
      @media (prefers-color-scheme: dark) {
        .card { background: #1a1a1a; border-color: #444; }
        .result-table th { background: #2a2a2a; }
        .result-table tr:nth-child(even) { background: #1a1a1a; }
        .result-table tr:hover { background: #252525; }
        .progress-bar { background: #333; }
      }
    </style>
  </head>
  <body>
    <h1>üè• Medical Receipt Scanner - Async Processing</h1>
    <p class="muted">Upload medical receipts and track processing in real-time. No timeout - we'll wait for results!</p>

    <div class="card">
      <label for="endpoint">n8n Webhook Endpoint</label>
      <input id="endpoint" type="text" value="http://localhost:5678/webhook/medical-start" placeholder="http://localhost:5678/webhook/medical-start" />
      <p class="muted">Default points to local n8n. Change to your deployed endpoint if needed.</p>
    </div>

    <div class="card">
      <label for="files">üì∏ Select Images (one or multiple)</label>
      <input id="files" type="file" accept="image/*" multiple />
      <div id="thumbs" class="thumbs"></div>
    </div>

    <div class="card">
      <button id="send" class="primary">
        üöÄ Upload & Start Processing
      </button>
      <button id="cancel" style="display: none;">
        ‚ùå Cancel Polling
      </button>
      <div id="status" class="muted" style="margin-top: 12px;">Ready to upload</div>
      
      <!-- Progress Bar -->
      <div id="progressContainer" class="progress-container">
        <div class="progress-bar">
          <div id="progressFill" class="progress-fill" style="width: 0%;">0%</div>
        </div>
        <div id="progressText" class="progress-text"></div>
      </div>
    </div>

    <div class="card">
      <h2>üìä Results <span id="resultCount">(0 records)</span></h2>
      <div id="resultTable"></div>
      <details style="margin-top: 16px;">
        <summary style="cursor: pointer; color: #777;">View Raw JSON Response</summary>
        <pre id="resultJson">(no data yet)</pre>
      </details>
    </div>

    <script>
      const $ = (sel) => document.querySelector(sel);
      const filesInput = $('#files');
      const thumbs = $('#thumbs');
      const endpointInput = $('#endpoint');
      const sendBtn = $('#send');
      const cancelBtn = $('#cancel');
      const statusEl = $('#status');
      const resultTableEl = $('#resultTable');
      const resultJsonEl = $('#resultJson');
      const resultCountEl = $('#resultCount');
      const progressContainer = $('#progressContainer');
      const progressFill = $('#progressFill');
      const progressText = $('#progressText');

      let pollingInterval = null;
      let currentJobId = null;

      // File preview
      filesInput.addEventListener('change', async () => {
        thumbs.innerHTML = '';
        const files = Array.from(filesInput.files || []);
        
        if (files.length === 0) return;
        
        for (const f of files) {
          const url = URL.createObjectURL(f);
          const div = document.createElement('div');
          div.className = 'thumb';
          div.innerHTML = `
            <img src="${url}" alt="${f.name}"/>
            <div style="margin-top: 4px; font-weight: 600; font-size: 12px;">${f.name}</div>
            <div class="muted">${(f.size/1024).toFixed(1)} KB</div>
          `;
          thumbs.appendChild(div);
        }
        
        statusEl.innerHTML = `${files.length} file(s) selected. Ready to upload.`;
      });

      // Convert file to base64
      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const dataUrl = reader.result;
              const base64 = String(dataUrl).split(',')[1] || '';
              resolve(base64.replace(/\s+/g, ''));
            } catch (e) { reject(e); }
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      // Build upload payload
      async function buildPayload() {
        const files = Array.from(filesInput.files || []);
        if (!files.length) throw new Error('Please select at least 1 image');
        
        statusEl.innerHTML = '<div class="spinner"></div>Converting images to base64...';
        const photos = await Promise.all(files.map(fileToBase64));
        const fileNames = files.map(f => f.name);
        
        return { photos, fileNames };
      }

      // Display results in table
      function displayResults(data) {
        let results = [];
        
        if (Array.isArray(data)) {
          results = data.map(item => item.json || item);
        } else if (data.results && Array.isArray(data.results)) {
          results = data.results;
        } else if (data.json) {
          results = [data.json];
        } else if (data.data && Array.isArray(data.data)) {
          results = data.data;
        } else {
          results = [data];
        }

        resultCountEl.textContent = `(${results.length} records)`;

        if (results.length === 0) {
          resultTableEl.innerHTML = '<div class="empty-result">No results yet. Processing...</div>';
          return;
        }

        let tableHTML = `
          <div style="overflow-x: auto;">
          <table class="result-table">
            <thead>
              <tr>
                <th style="width: 40px;">#</th>
                <th>Date</th>
                <th>Payee/Hospital</th>
                <th>Department & Remarks</th>
                <th>Receipt No.</th>
                <th style="width: 120px;">Amount</th>
                <th>Source File</th>
              </tr>
            </thead>
            <tbody>
        `;

        results.forEach((result, index) => {
          const date = result.date_of_payment || result.date || '-';
          const payee = result.payee || result.provider || '-';
          const remarks = result.department_remarks || result.remarks || '-';
          const receiptNo = result.receipt_number || result.receiptNumber || '-';
          const amount = typeof result.amount === 'number' ? 
            result.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : 
            (result.amount || '0.00');
          const sourceFile = result.source_file || result.fileName || '-';
          const status = result.status || 'ok';
          const error = result.error || '';

          const rowClass = status === 'error' ? 'style="background: #fee;"' : '';
          
          tableHTML += `
            <tr ${rowClass}>
              <td>${index + 1}</td>
              <td>${date}</td>
              <td>${payee}</td>
              <td>
                ${remarks}
                ${error ? '<br/><span class="err">‚ö†Ô∏è ' + error + '</span>' : ''}
              </td>
              <td>${receiptNo}</td>
              <td class="amount">${amount}</td>
              <td><small>${sourceFile}</small></td>
            </tr>
          `;
        });

        tableHTML += `
            </tbody>
          </table>
          </div>
        `;

        resultTableEl.innerHTML = tableHTML;
      }

      // Update progress bar
      function updateProgress(done, expected) {
        if (!expected || expected === 0) return;
        
        const percent = Math.round((done / expected) * 100);
        progressFill.style.width = percent + '%';
        progressFill.textContent = percent + '%';
        progressText.textContent = `Processed ${done} of ${expected} files`;
      }

      // Poll status endpoint
      async function pollStatus(jobId) {
        try {
          const endpoint = endpointInput.value.trim().replace('/medical-start', '/medical-status');
          const statusUrl = `${endpoint}?jobId=${jobId}`;
          
          console.log('Polling status:', statusUrl);
          
          const res = await fetch(statusUrl, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' }
          });
          
          if (!res.ok) {
            throw new Error(`Status check failed: ${res.status}`);
          }
          
          const data = await res.json();
          console.log('Status response:', data);
          
          // Update UI based on status
          if (data.status === 'processing') {
            statusEl.innerHTML = `
              <span class="status-badge status-processing">
                <div class="spinner"></div>Processing...
              </span>
              ${data.progress ? ` (${data.progress})` : ''}
            `;
            
            // Try to extract progress
            if (data.progress) {
              const match = data.progress.match(/(\d+)\/(\d+)/);
              if (match) {
                const done = parseInt(match[1]);
                const expected = parseInt(match[2]);
                updateProgress(done, expected);
              }
            }
          } else if (data.status === 'completed' || data.status === 'completed-with-errors') {
            // Job completed!
            clearInterval(pollingInterval);
            pollingInterval = null;
            
            const hasErrors = data.status === 'completed-with-errors';
            statusEl.innerHTML = `
              <span class="status-badge ${hasErrors ? 'status-error' : 'status-completed'}">
                ‚úì ${hasErrors ? 'Completed with errors' : 'Completed successfully'}
              </span>
            `;
            
            // Update progress to 100%
            progressFill.style.width = '100%';
            progressFill.textContent = '100%';
            progressText.textContent = 'Processing complete!';
            
            // Display results
            if (data.results && data.results.length > 0) {
              displayResults(data.results);
              resultJsonEl.textContent = JSON.stringify(data, null, 2);
            }
            
            // Re-enable upload button
            sendBtn.disabled = false;
            cancelBtn.style.display = 'none';
            currentJobId = null;
            
          } else {
            // Unknown status
            statusEl.innerHTML = `<span class="warning">Status: ${data.status}</span>`;
          }
          
        } catch (error) {
          console.error('Polling error:', error);
          statusEl.innerHTML = `<span class="err">‚ùå Error checking status: ${error.message}</span>`;
        }
      }

      // Start polling
      function startPolling(jobId, expected) {
        currentJobId = jobId;
        
        // Show progress container
        progressContainer.classList.add('active');
        updateProgress(0, expected);
        
        // Show cancel button
        cancelBtn.style.display = 'inline-block';
        
        // Poll every 2 seconds
        pollingInterval = setInterval(() => {
          pollStatus(jobId);
        }, 2000);
        
        // Poll immediately
        pollStatus(jobId);
      }

      // Stop polling
      function stopPolling() {
        if (pollingInterval) {
          clearInterval(pollingInterval);
          pollingInterval = null;
        }
        
        currentJobId = null;
        sendBtn.disabled = false;
        cancelBtn.style.display = 'none';
        statusEl.innerHTML = 'Polling cancelled';
        progressContainer.classList.remove('active');
      }

      // Upload and start processing
      async function send() {
        try {
          // Disable button
          sendBtn.disabled = true;
          resultTableEl.innerHTML = '';
          resultJsonEl.textContent = '';
          
          // Build payload
          const payload = await buildPayload();
          
          // Send to webhook
          statusEl.innerHTML = '<div class="spinner"></div>Uploading to server...';
          const endpoint = endpointInput.value.trim();
          
          const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          
          if (!res.ok) {
            throw new Error(`Upload failed: ${res.status} ${res.statusText}`);
          }
          
          const data = await res.json();
          console.log('Upload response:', data);
          
          if (!data.success || !data.jobId) {
            throw new Error(data.error || 'Failed to get jobId from server');
          }
          
          // Start polling for results
          statusEl.innerHTML = `
            <span class="ok">‚úì Upload successful!</span><br/>
            <span class="muted">JobId: ${data.jobId}</span>
          `;
          
          const expected = data.expected || payload.photos.length;
          startPolling(data.jobId, expected);
          
        } catch (error) {
          console.error('Upload error:', error);
          statusEl.innerHTML = `<span class="err">‚ùå Error: ${error.message}</span>`;
          sendBtn.disabled = false;
          progressContainer.classList.remove('active');
        }
      }

      // Event listeners
      sendBtn.addEventListener('click', send);
      cancelBtn.addEventListener('click', stopPolling);

      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
        if (pollingInterval) {
          clearInterval(pollingInterval);
        }
      });
    </script>
  </body>
</html>